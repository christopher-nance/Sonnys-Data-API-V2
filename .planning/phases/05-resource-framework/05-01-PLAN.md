---
phase: 05-resource-framework
plan: 01
type: tdd
---

<objective>
Build base resource classes with auto-pagination list() and detail get() methods that all API resource subclasses will inherit.

Purpose: Establish the reusable patterns (paginated list, non-paginated list, get-by-ID) that Phases 6-8 resource classes inherit — TDD ensures the pagination loop and envelope parsing are correct before any real endpoints use them.
Output: `_resources.py` with BaseResource, ListableResource, GettableResource — tested auto-pagination loop, non-paginated list, and get() method.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-resource-framework/05-RESEARCH.md

# Key source files:
@src/sonnys_data_client/_client.py
@src/sonnys_data_client/types/_base.py
@src/sonnys_data_client/types/__init__.py
@src/sonnys_data_client/__init__.py

# Relevant prior summaries:
@.planning/phases/03-rate-limiting/03-02-SUMMARY.md
@.planning/phases/04-response-models/04-03-SUMMARY.md

**Tech stack available:** requests, pydantic v2, pytest

**Established patterns:**
- `_request(method, path, *, params)` as single HTTP pipeline (03-02)
- SonnysModel with ConfigDict(populate_by_name, alias_generator=to_camel) (04-01)
- Module-level functions for testability (02-02)
- Underscore-prefixed internals, public API via __init__.py (01-01)
- Mock session.request + mock time.sleep for deterministic tests (03-02)
- Mock responses via requests.models.Response with _content injection (02-02)

**Constraining decisions:**
- Phase 02: `_request()` returns `requests.Response` — resource methods call `response.json()` to get dict
- Phase 04: All 30 Pydantic models available in `sonnys_data_client.types`
- Research: Offset starts at 1 (per API spec minimum), items key varies per endpoint
- Research: Non-paginated endpoints (sites, employees) need special handling — skip offset/limit params
- Research: No generic T — use concrete class attributes for model type
- Research: Use model_validate() instead of Model(**item) for Pydantic v2 alias handling
</context>

<feature>
  <name>Base resource classes with auto-pagination and detail retrieval</name>
  <files>src/sonnys_data_client/_resources.py, tests/test_resources.py</files>
  <behavior>
    **Auto-paginated list (multi-page):**
    Given a resource with _path="/customer", _items_key="customers", _model=CustomerListItem, _default_limit=100
    When the API returns 250 total items across 3 pages (100 + 100 + 50)
    Then list() returns all 250 parsed model instances
    And requests use offset=1, offset=101, offset=201

    **Single-page list:**
    Given total <= limit (e.g., 50 items with limit=100)
    Then list() returns all 50 items from one request

    **Empty list:**
    Given total = 0 and items array is empty
    Then list() returns empty list from one request

    **Non-paginated list:**
    Given a resource with _paginated=False (e.g., sites)
    Then list() makes one request with no offset/limit params
    And returns all items from data[_items_key] parsed through _model

    **List with extra params:**
    Given list(first_name="John", status="active")
    Then offset/limit AND extra params are all forwarded to _request(params=...)

    **Detail get:**
    Given get("12345") on a resource with _detail_path="/customer/{id}", _detail_model=Customer
    Then _request("GET", "/customer/12345") is called
    And response.json()["data"] is parsed into Customer model instance

    **Detail get with complex path:**
    Given _detail_path="/washbook/account/{id}/detail"
    Then get("999") calls _request("GET", "/washbook/account/999/detail")
  </behavior>
  <implementation>
    Create `src/sonnys_data_client/_resources.py`:

    **BaseResource:** Stores `_client` reference via `__init__(self, client)`.

    **ListableResource(BaseResource):** Class attributes: `_path: str`, `_items_key: str`, `_model: type[SonnysModel]`, `_default_limit: int = 100`, `_paginated: bool = True`.
    - `list(self, **params) -> list`: If `_paginated`, loop with offset starting at 1, increment by `_default_limit`, call `self._client._request("GET", self._path, params={"limit": self._default_limit, "offset": offset, **params})`. Parse each page's `response.json()["data"][self._items_key]` through `self._model.model_validate(item)`. Stop when `offset > total`. If not `_paginated`, single request with just `**params` (no offset/limit), return parsed items.

    **GettableResource(BaseResource):** Class attributes: `_detail_path: str`, `_detail_model: type[SonnysModel]`.
    - `get(self, id: str) -> SonnysModel`: Format `_detail_path` replacing `{id}` with id, call `self._client._request("GET", formatted_path)`, parse `response.json()["data"]` through `self._detail_model.model_validate()`.

    Both are independent mixins — concrete resource subclasses (Phase 6+) inherit one or both:
    - Items → ListableResource only
    - Customers → ListableResource + GettableResource
    - Sites → ListableResource with _paginated=False

    **Test approach:** Create concrete test subclasses of ListableResource/GettableResource with dummy config. Mock `client._request` to return canned `requests.Response` objects with JSON payloads matching the API envelope patterns from 05-RESEARCH.md. Use simple test models (can reuse existing Pydantic models or create minimal test-only models).
  </implementation>
</feature>

<verification>
python -m pytest tests/test_resources.py -v
All tests pass, no import errors.
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactor complete if needed (REFACTOR)
- Auto-pagination correctly aggregates multi-page results with offset 1-based
- Non-paginated list returns full array without offset/limit params
- get() correctly parses detail envelope with {id} path substitution
- All 2-3 commits present
- Phase 5 complete (single plan phase)
</success_criteria>

<output>
After completion, create `.planning/phases/05-resource-framework/05-01-SUMMARY.md`:

# Phase 5 Plan 1: Base Resource Classes Summary

**[substantive one-liner]**

## Performance
- Duration, started, completed, files modified

## Accomplishments
- Key outcomes

## TDD Cycle

### RED - Failing Tests
### GREEN - Implementation
### REFACTOR

## Task Commits

## Files Created/Modified

## Decisions Made

## Deviations from Plan

## Issues Encountered

## Next Phase Readiness
</output>
