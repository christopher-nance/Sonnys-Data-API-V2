---
phase: 19-stats-foundation
plan: 01
type: tdd
---

<objective>
Create date range parsing and validation utilities for the stats module.

Purpose: Every stat method (total_sales, total_washes, conversion_rate, etc.) accepts start/end date parameters. A shared, well-tested utility ensures consistent date handling across all stat methods added in later phases.
Output: Working, tested `parse_date_range()` function in `_date_utils.py`.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/sonnys_data_client/_resources.py
@src/sonnys_data_client/resources/_transactions.py

**Established patterns:**
- `Transactions._convert_dates()` converts ISO strings to Unix timestamps (static method)
- `SonnysModel` uses `pydantic` with camelCase aliases
- `datetime.fromisoformat()` for parsing, `timezone.utc` for timezone normalization

**Constraining decisions:**
- Phase 2: `_convert_dates` pattern for date handling already exists on Transactions
- Phase 5: BaseResource pattern — stats will extend BaseResource, not ListableResource
</context>

<feature>
  <name>Date range parsing and validation</name>
  <files>src/sonnys_data_client/_date_utils.py, tests/test_date_utils.py</files>
  <behavior>
    `parse_date_range(start, end)` accepts start/end as ISO-8601 strings (e.g. "2026-01-01") or datetime objects, returns a validated tuple of (start_dt, end_dt) as timezone-aware UTC datetimes.

    Cases:
    - ISO string pair ("2026-01-01", "2026-01-31") → (datetime(2026,1,1,tzinfo=utc), datetime(2026,1,31,tzinfo=utc))
    - datetime pair → passes through with UTC normalization
    - Mixed (string start, datetime end) → both normalized
    - start > end → raises ValueError
    - Same day (start == end) → valid, returns equal datetimes
    - Naive datetimes → converted to UTC
    - Timezone-aware datetimes → preserved as-is
    - Invalid string → raises ValueError
  </behavior>
  <implementation>
    Create `src/sonnys_data_client/_date_utils.py` with:

    ```python
    def parse_date_range(start: str | datetime, end: str | datetime) -> tuple[datetime, datetime]:
    ```

    - Use `datetime.fromisoformat()` for string parsing (same as Transactions._convert_dates)
    - If naive (no tzinfo), attach `timezone.utc`
    - If aware, leave as-is
    - Validate start <= end, raise `ValueError("start must be before or equal to end")` if not
    - Return (start_dt, end_dt) tuple
  </implementation>
</feature>

<verification>
pytest tests/test_date_utils.py -v passes all tests
</verification>

<success_criteria>
- Failing test written and committed
- Implementation passes test
- Refactor complete (if needed)
- All 2-3 commits present
- `parse_date_range()` handles all documented cases
</success_criteria>

<output>
After completion, create `.planning/phases/19-stats-foundation/19-01-SUMMARY.md`:

# Phase 19 Plan 1: Date Range Parsing & Validation Summary

**[Substantive one-liner]**

## Accomplishments

## TDD Cycle
### RED
### GREEN
### REFACTOR

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Step
Ready for 19-02-PLAN.md
</output>
