# Phase 1: Project Foundation - Research

**Researched:** 2026-02-10
**Domain:** Python package scaffolding + REST API client library architecture
**Confidence:** HIGH

<research_summary>
## Summary

Researched modern Python packaging best practices and how production API client libraries (Stripe, OpenAI, Twilio, PyGithub) structure their codebases. The standard approach uses pyproject.toml with hatchling as build backend, src layout, and a resource-based architecture where the root client owns the HTTP session and exposes resource namespaces via `@cached_property`.

Key finding: The OpenAI/Stainless pattern (client passes `self` to resource classes via `@cached_property`) is the cleanest match for our `client.transactions.list()` API surface. Stripe's mixin-based approach is also proven but heavier. Both use a single shared HTTP session with auth injected at the client level.

**Primary recommendation:** Use hatchling + src layout + OpenAI-style `@cached_property` resource pattern. Underscore-prefix internal modules (`_client.py`, `_exceptions.py`). One file per resource under `resources/`, Pydantic models under `types/`.
</research_summary>

<standard_stack>
## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| requests | 2.32.5 (Aug 2025) | HTTP client | De facto standard for synchronous HTTP in Python, stable API |
| pydantic | 2.12.5 (Nov 2025) | Response models | Typed, validated, IDE autocomplete, Pydantic v2 is fast |
| hatchling | latest | Build backend | PyPA-maintained, PEP 621-native, recommended for pure-Python |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| pytest | >=7.0 | Testing | Dev dependency for unit/integration tests |
| ruff | >=0.1 | Linting + formatting | Dev dependency, replaces flake8+isort+black |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| hatchling | setuptools (>=61) | setuptools is more mature but hatchling has better defaults for new projects |
| hatchling | flit-core | flit is simpler but hatchling is more flexible |
| requests | httpx | httpx supports async but adds complexity; sync-only scope means requests is simpler |

**Installation:**
```bash
pip install requests pydantic
# Dev:
pip install pytest ruff
```
</standard_stack>

<architecture_patterns>
## Architecture Patterns

### Recommended Project Structure
```
sonnys-data-client/
├── pyproject.toml
├── LICENSE
├── README.md
├── src/
│   └── sonnys_data_client/
│       ├── __init__.py              # Public API exports
│       ├── _client.py               # SonnysClient main class
│       ├── _base_resource.py        # Base resource class
│       ├── _exceptions.py           # Exception hierarchy
│       ├── _pagination.py           # Auto-pagination logic
│       ├── _rate_limiter.py         # Sliding window rate limiter
│       ├── _version.py              # __version__
│       ├── resources/
│       │   ├── __init__.py
│       │   ├── transactions.py
│       │   ├── customers.py
│       │   ├── items.py
│       │   ├── giftcards.py
│       │   ├── washbooks.py
│       │   ├── recurring.py
│       │   ├── employees.py
│       │   └── sites.py
│       └── types/
│           ├── __init__.py
│           ├── transaction.py
│           ├── customer.py
│           ├── item.py
│           ├── giftcard.py
│           ├── washbook.py
│           ├── recurring.py
│           ├── employee.py
│           └── site.py
└── tests/
    ├── __init__.py
    ├── test_client.py
    └── ...
```

### Pattern 1: Client Owns Session, Resources via @cached_property (OpenAI/Stainless)
**What:** Root client holds HTTP session + credentials, exposes resource namespaces as lazy-loaded cached properties. Resources receive client reference via constructor.
**When to use:** Any resource-based API client
**Why chosen:** Cleanest match for `client.transactions.list()` pattern. Used by OpenAI, Anthropic, and other modern SDKs generated by Stainless.
**Example:**
```python
from functools import cached_property

class SonnysClient:
    def __init__(self, api_id: str, api_key: str, site_code: str):
        self._session = requests.Session()
        self._session.headers.update({
            "X-Sonnys-API-ID": api_id,
            "X-Sonnys-API-Key": api_key,
            "X-Sonnys-Site-Code": site_code,
        })

    @cached_property
    def transactions(self) -> Transactions:
        return Transactions(self)

    @cached_property
    def customers(self) -> Customers:
        return Customers(self)

class BaseResource:
    def __init__(self, client: SonnysClient):
        self._client = client

class Transactions(BaseResource):
    def list(self, **params) -> list[Transaction]:
        return self._client._request("GET", "/transaction", params=params)
```

### Pattern 2: Underscore-Prefixed Internal Modules
**What:** Prefix internal implementation files with underscore (`_client.py`, `_exceptions.py`). Public API exposed only through `__init__.py`.
**When to use:** Always for library packages
**Why:** Signals to users what's public vs internal. OpenAI/Stainless convention.

### Anti-Patterns to Avoid
- **Module-level client singleton:** Don't use `stripe.api_key = "..."` pattern (Stripe's legacy approach). Per-instance credentials are better for multi-tenant use.
- **Resources creating their own sessions:** All HTTP goes through the root client's session.
- **Flat module structure:** Don't dump all classes in one file. One file per resource, one file per model type.
</architecture_patterns>

<dont_hand_roll>
## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Package metadata | Custom setup.py | pyproject.toml (PEP 621) | Universal standard since 2022, all tools support it |
| Build system | Custom scripts | hatchling | Handles sdist, wheel, editable installs correctly |
| HTTP session management | Manual connection handling | requests.Session | Connection pooling, cookie persistence, header defaults |
| Data validation/parsing | Manual dict parsing | Pydantic v2 models | Type safety, validation, IDE autocomplete, serialization |
| Version pinning format | Loose pins | Compatible release (`>=2.10,<3`) | Prevents breaking changes while allowing patches |

**Key insight:** Python packaging has been standardized around pyproject.toml + PEP 621. Every manual approach is now worse than the standard tooling. Pydantic v2 eliminates all manual response parsing.
</dont_hand_roll>

<common_pitfalls>
## Common Pitfalls

### Pitfall 1: Flat Layout Masking Import Bugs
**What goes wrong:** Using flat layout (package at project root) causes `python -c "import sonnys_data_client"` to import local source instead of installed package, hiding packaging errors.
**Why it happens:** Python adds CWD to sys.path first.
**How to avoid:** Use src layout. Forces `pip install -e .` for development, which validates build config.
**Warning signs:** Tests pass locally but package fails after `pip install`.

### Pitfall 2: Missing `py.typed` Marker
**What goes wrong:** IDE users don't get type hints from your library even though you have type annotations.
**Why it happens:** PEP 561 requires a `py.typed` marker file in the package to signal type hint support.
**How to avoid:** Add empty `src/sonnys_data_client/py.typed` file and include it in package data.
**Warning signs:** `mypy` reports "Skipping analyzing: no py.typed marker" for your package.

### Pitfall 3: Using `typing.Optional` and `typing.Union` Instead of `X | Y`
**What goes wrong:** Verbose, hard-to-read type hints that require imports from `typing`.
**Why it happens:** Habit from Python 3.9 and earlier.
**How to avoid:** With Python 3.10+ floor, use native `str | None` and `int | str` syntax everywhere.
**Warning signs:** `from typing import Optional, Union, List, Dict` at top of files.

### Pitfall 4: License Field Format (PEP 639)
**What goes wrong:** Build tools warn about deprecated license format.
**Why it happens:** PEP 639 (Dec 2024) changed license format from `{text = "MIT"}` to SPDX string `"MIT"`.
**How to avoid:** Use `license = "MIT"` and `license-files = ["LICENSE"]` in pyproject.toml.
**Warning signs:** Deprecation warnings during build.
</common_pitfalls>

<code_examples>
## Code Examples

### pyproject.toml (Verified Best Practices 2026)
```toml
# Source: Python Packaging User Guide + PEP 621 + PEP 639
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "sonnys-data-client"
version = "0.1.0"
description = "Python client for the Sonny's Carwash Controls Data API"
requires-python = ">=3.10"
license = "MIT"
license-files = ["LICENSE"]
dependencies = [
    "requests>=2.28,<3",
    "pydantic>=2.10,<3",
]

[project.optional-dependencies]
dev = ["pytest>=7.0", "ruff>=0.1"]

[tool.hatch.build.targets.wheel]
packages = ["src/sonnys_data_client"]
```

### Client Class Shell (OpenAI/Stainless Pattern)
```python
# Source: Pattern from openai-python, stripe-python v8
from functools import cached_property
import requests

class SonnysClient:
    BASE_URL = "https://trigonapi.sonnyscontrols.com/v1"

    def __init__(
        self,
        api_id: str,
        api_key: str,
        site_code: str | None = None,
    ):
        self._session = requests.Session()
        self._session.headers.update({
            "X-Sonnys-API-ID": api_id,
            "X-Sonnys-API-Key": api_key,
        })
        if site_code:
            self._session.headers["X-Sonnys-Site-Code"] = site_code

    @cached_property
    def transactions(self):
        from .resources.transactions import Transactions
        return Transactions(self)

    @cached_property
    def customers(self):
        from .resources.customers import Customers
        return Customers(self)

    # ... more resources

    def close(self):
        self._session.close()

    def __enter__(self):
        return self

    def __exit__(self, *args):
        self.close()
```

### Base Resource Pattern
```python
# Source: Pattern from openai-python SyncAPIResource
class BaseResource:
    def __init__(self, client: "SonnysClient"):
        self._client = client

    def _request(self, method: str, path: str, **kwargs):
        return self._client._request(method, path, **kwargs)
```
</code_examples>

<sota_updates>
## State of the Art (2025-2026)

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| setup.py / setup.cfg | pyproject.toml (PEP 621) | 2022+ | Universal standard, all build tools support it |
| `license = {text = "MIT"}` | `license = "MIT"` (SPDX) | Dec 2024 (PEP 639) | New format required for modern builds |
| setuptools as default backend | hatchling recommended | 2023+ | Better defaults, PyPA-maintained |
| `typing.Optional[str]` | `str \| None` | Python 3.10 (2021) | Cleaner syntax, no typing import needed |
| Module-level API keys (Stripe v7) | Per-instance clients (Stripe v8) | 2023 | Thread-safe, multi-tenant friendly |

**New tools/patterns to consider:**
- **uv**: Fast Python package installer/resolver. Can replace pip for development workflows.
- **Stainless pattern**: `@cached_property` resource initialization used by OpenAI, Anthropic SDKs.

**Deprecated/outdated:**
- **setup.py**: Still works but not recommended for new projects.
- **`typing.List`, `typing.Dict`**: Use `list`, `dict` directly (Python 3.9+).
- **Module-level singletons for API clients**: Per-instance is the modern pattern.
</sota_updates>

<open_questions>
## Open Questions

1. **Package name: `sonnys-data-client` vs `sonnys-data-api`?**
   - What we know: PROJECT.md says `sonnys-data-client`. PyPI naming convention uses hyphens.
   - What's unclear: Import name will be `sonnys_data_client` (underscores). Is this the desired import name?
   - Recommendation: Proceed with `sonnys-data-client` (pip name) / `sonnys_data_client` (import name) per PROJECT.md.

2. **Should we include `py.typed` marker from the start?**
   - What we know: PEP 561 requires it for downstream mypy/pyright users.
   - What's unclear: Whether consumers need type checking support immediately.
   - Recommendation: Yes, include it. Zero cost, enables IDE support for consumers.
</open_questions>

<sources>
## Sources

### Primary (HIGH confidence)
- [Python Packaging User Guide - pyproject.toml](https://packaging.python.org/en/latest/guides/writing-pyproject-toml/) — PEP 621 format, build backends
- [Python Packaging User Guide - src layout vs flat layout](https://packaging.python.org/en/latest/discussions/src-layout-vs-flat-layout/) — layout recommendation
- [PyPI: requests 2.32.5](https://pypi.org/project/requests/) — current version verified
- [PyPI: pydantic 2.12.5](https://pypi.org/project/pydantic/) — current version verified
- [PEP 639](https://peps.python.org/pep-0639/) — SPDX license format
- [stripe/stripe-python](https://github.com/stripe/stripe-python) — resource-based client architecture
- [openai/openai-python](https://github.com/openai/openai-python) — @cached_property resource pattern
- [Stripe StripeClient Migration Guide](https://github.com/stripe/stripe-python/wiki/Migration-guide-for-v8-(StripeClient)) — per-instance client pattern

### Secondary (MEDIUM confidence)
- [DeepWiki: stripe-python API Resources](https://deepwiki.com/stripe/stripe-python/3-api-resources) — mixin pattern analysis
- [DeepWiki: openai-python Architecture](https://deepwiki.com/openai/openai-python) — resource hierarchy
- [DeepWiki: twilio-python](https://deepwiki.com/twilio/twilio-python/6-core-resource-apis) — domain/version/resource pattern
- [DeepWiki: PyGithub](https://deepwiki.com/PyGithub/PyGithub) — pagination, lazy loading
- [pyOpenSci Python Package Structure](https://www.pyopensci.org/python-package-guide/package-structure-code/python-package-structure.html) — src layout advocacy

### Tertiary (LOW confidence - needs validation)
- None — all findings verified against primary sources
</sources>

<metadata>
## Metadata

**Research scope:**
- Core technology: Python packaging (pyproject.toml, hatchling, src layout)
- Ecosystem: requests 2.32.5, pydantic 2.12.5
- Patterns: Resource-based client architecture (Stripe, OpenAI, Twilio, PyGithub)
- Pitfalls: Flat layout imports, py.typed marker, license format, type hint syntax

**Confidence breakdown:**
- Standard stack: HIGH — verified from PyPI and PyPA docs
- Architecture: HIGH — verified from multiple production SDK source codes
- Pitfalls: HIGH — documented in official packaging guides
- Code examples: HIGH — derived from official patterns and verified docs

**Research date:** 2026-02-10
**Valid until:** 2026-03-12 (30 days — Python packaging ecosystem is stable)
</metadata>

---

*Phase: 01-project-foundation*
*Research completed: 2026-02-10*
*Ready for planning: yes*
