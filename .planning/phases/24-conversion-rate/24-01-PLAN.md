---
phase: 24-conversion-rate
type: execute
---

<objective>
Implement conversion_rate() stat method composing retail_wash_count() and new_memberships_sold() into a membership conversion KPI.

Purpose: Provide the key business metric — what percentage of wash customers convert to recurring membership plans.
Output: ConversionResult model and conversion_rate() method on StatsResource.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Dependencies (both complete):
@.planning/phases/22-wash-analytics/22-01-SUMMARY.md
@.planning/phases/23-membership-analytics/23-01-SUMMARY.md

# Key source files:
@src/sonnys_data_client/resources/_stats.py
@src/sonnys_data_client/types/_stats.py
@src/sonnys_data_client/types/__init__.py
@src/sonnys_data_client/__init__.py
@tests/test_types.py

**Tech stack available:** pydantic, requests, pytest
**Established patterns:**
- SalesResult/WashResult models in types/_stats.py extending SonnysModel
- Int-return stat methods (retail_wash_count, new_memberships_sold) for simple counts
- Export wiring: types/_stats.py → types/__init__.py → __init__.py

**Constraining decisions:**
- [Phase 22]: retail_wash_count() returns int directly — designed as conversion rate denominator
- [Phase 23]: new_memberships_sold() returns int — designed as conversion rate numerator
- [Phase 22]: Each method makes independent API calls — efficiency deferred to report() in Phase 25
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConversionResult model and wire package exports</name>
  <files>src/sonnys_data_client/types/_stats.py, src/sonnys_data_client/types/__init__.py, src/sonnys_data_client/__init__.py, tests/test_types.py</files>
  <action>Add ConversionResult class to types/_stats.py extending SonnysModel with four fields:
- rate: float (the conversion percentage as a decimal, e.g. 0.15 = 15%)
- new_memberships: int (numerator — count of membership activations)
- retail_washes: int (denominator component — count of retail wash transactions)
- total_opportunities: int (denominator — new_memberships + retail_washes)

Add Google-style docstring following SalesResult/WashResult pattern: class docstring describing what conversion_rate() returns, field semantics.

Wire exports:
1. types/__init__.py: Add ConversionResult import from _stats and to __all__
2. __init__.py: Add ConversionResult import from types and to __all__
3. tests/test_types.py: Update __all__ count assertion from 32 to 33</action>
  <verify>python -c "from sonnys_data_client import ConversionResult; print(ConversionResult.__fields__)" succeeds. python -m pytest tests/test_types.py passes.</verify>
  <done>ConversionResult importable from package root with 4 typed fields. __all__ count test passes at 33.</done>
</task>

<task type="auto">
  <name>Task 2: Implement conversion_rate() on StatsResource</name>
  <files>src/sonnys_data_client/resources/_stats.py</files>
  <action>Add conversion_rate(start, end) method to StatsResource that:
1. Calls self.new_memberships_sold(start, end) to get numerator
2. Calls self.retail_wash_count(start, end) to get denominator component
3. Computes total_opportunities = new_memberships + retail_washes
4. Computes rate = new_memberships / total_opportunities (handle division by zero: if total_opportunities == 0, rate = 0.0)
5. Returns ConversionResult(rate=rate, new_memberships=new_memberships, retail_washes=retail_washes, total_opportunities=total_opportunities)

Add ConversionResult to imports at top of file.

Add Google-style docstring following existing method patterns: describe what it computes, Args (start, end with ISO-8601/datetime), Returns (ConversionResult), Raises (ValueError for bad dates), Example usage.</action>
  <verify>python -m pytest tests/ passes (all existing tests). Manual: python -c "from sonnys_data_client.resources._stats import StatsResource; print('conversion_rate' in dir(StatsResource))" returns True.</verify>
  <done>conversion_rate(start, end) returns ConversionResult with correct formula including zero-division protection. All existing tests pass.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -m pytest tests/` — all tests pass
- [ ] `python -c "from sonnys_data_client import ConversionResult"` — importable
- [ ] `python -c "from sonnys_data_client import SonnysClient; print('conversion_rate' in dir(SonnysClient('x','y','z').stats))"` — method exists on client.stats
- [ ] ConversionResult has rate, new_memberships, retail_washes, total_opportunities fields
- [ ] Division by zero handled (returns rate=0.0 when no washes or memberships)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- conversion_rate() correctly composes new_memberships_sold() and retail_wash_count()
- ConversionResult model exposes computation components
- Zero-division edge case handled
</success_criteria>

<output>
After completion, create `.planning/phases/24-conversion-rate/24-01-SUMMARY.md`
</output>
