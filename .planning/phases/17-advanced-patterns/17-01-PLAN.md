---
phase: 17-advanced-patterns
plan: 01
type: execute
---

<objective>
Create the Advanced Patterns guide covering multi-site operations, rate limiting deep dive, performance optimization, and context manager patterns.

Purpose: Document SDK usage patterns that go beyond single-resource CRUD — the patterns real users need when building production data pipelines across multiple sites.
Output: `docs/guides/advanced-patterns.md` with multi-site, rate limiting, performance, and context manager sections.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (same subsystem):
@.planning/phases/16-error-troubleshoot/16-02-SUMMARY.md

# Key source files (for accurate code examples):
@src/sonnys_data_client/_client.py
@src/sonnys_data_client/_rate_limiter.py
@src/sonnys_data_client/_resources.py

# Existing guides (avoid duplication, cross-reference):
@docs/guides/error-handling.md
@docs/guides/transactions.md

**Tech stack available:** mkdocs-material, mkdocstrings, pymdownx extensions, admonition
**Established patterns:** admonition-rich guides, code examples with realistic data, tip/warning/note callouts, cross-reference links between guides
**Constraining decisions:**
- [Phase 16]: Logging & debugging docs already in error-handling.md — advanced-patterns should cross-reference, not duplicate
- [Phase 14]: Transaction advanced patterns (multi-day exports, cross-resource lookups) already documented — reference and extend, don't repeat
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create advanced-patterns.md with Multi-Site Operations and Rate Limiting Deep Dive</name>
  <files>docs/guides/advanced-patterns.md</files>
  <action>
Create `docs/guides/advanced-patterns.md` with the following sections:

**Introduction** — Brief overview of what this guide covers and who it's for (developers building production pipelines, multi-site operators).

**Multi-Site Operations** — This is the primary gap in current docs. Cover:

1. **Single-Site vs Multi-Site Setup** — Show constructor with `site_code` param, explain when to use it vs omitting it. Reference PROJECT.md context: user operates WashU and Icon databases with separate credentials.

2. **Iterating Multiple Sites** — Pattern for looping over a list of site codes with separate client instances. Show realistic example: pulling daily transaction counts per site.

3. **Multi-Database Operations** — Pattern for operating across separate API credentials (not just site codes). Show creating clients for different databases (e.g., WashU vs Icon) and combining results.

4. **Consolidated Reporting** — Pattern for aggregating data across sites into a single report. Example: total revenue by site for a date range, using a dict to accumulate results.

5. **Context Managers for Multi-Site** — Show `contextlib.ExitStack` pattern for managing multiple client lifecycles cleanly. This is the production-safe way to handle multiple clients.

**Rate Limiting Deep Dive** — Expand beyond what error-handling.md covers (which is: exception handling for 429s, retry behavior). Cover:

1. **How the Rate Limiter Works** — Explain sliding window algorithm: 20 requests per 15-second window, per-client instance. Each client has its own independent rate limiter. The limiter sleeps pre-request if at capacity — requests never fail due to client-side rate limiting.

2. **Multi-Client Rate Limit Considerations** — CRITICAL: If multiple clients share the same `api_id`, the API server enforces a shared 20 req/15s limit even though each client has its own local rate limiter. Document this gotcha with a warning admonition. Recommend: if sharing `api_id` across N clients, expect effective per-client throughput of ~20/N req/15s. The server-side 429 is handled by `max_retries` but it's better to space requests.

3. **Request Budget Forecasting** — Help users estimate how many requests a bulk export will consume. Formula: `pages = ceil(total_records / 100)`. At 20 req/15s, a 10,000-record export needs ~100 requests = ~75 seconds. Include a simple table: record count → pages → estimated time.

4. **Staying Within Limits** — Practical tips: add `time.sleep()` between site iterations in multi-site loops, use `load_job()` for bulk exports (fewer requests than paginated `list()`), keep date ranges narrow to reduce page counts.

Cross-reference error-handling.md for exception handling and retry configuration. Use `!!! tip`, `!!! warning`, `!!! note` admonitions consistent with existing guides. Use realistic Sonny's car wash data in examples (site codes, transaction dates, customer IDs).

Do NOT duplicate content already in error-handling.md (retry recipes, exception hierarchy, logging config). Instead link to it: `[Error Handling guide](error-handling.md)`.
  </action>
  <verify>Confirm docs/guides/advanced-patterns.md exists, has Multi-Site Operations and Rate Limiting Deep Dive sections, contains code examples, and has no broken cross-reference links.</verify>
  <done>advanced-patterns.md created with Multi-Site Operations (5 subsections) and Rate Limiting Deep Dive (4 subsections), all with code examples and admonitions.</done>
</task>

<task type="auto">
  <name>Task 2: Add Performance Optimization section</name>
  <files>docs/guides/advanced-patterns.md</files>
  <action>
Append to `docs/guides/advanced-patterns.md`:

**Performance Optimization** — Practical guidance for getting data out efficiently:

1. **Choosing the Right Method** — Decision tree for transaction retrieval: `list()` for quick summaries (fastest, no cache), `list_v2()` for enriched data (10-min cache), `load_job()` for bulk full-detail exports (slowest but most complete). Reference the comparison table in transactions.md but frame it from a performance perspective. Add a `!!! tip` recommending `list()` as default unless you need specific enriched fields.

2. **Date Range Sizing** — Narrower date ranges = fewer pages = fewer requests. Show the tradeoff: 1-day ranges are safest for `load_job()` (required), while `list()` can handle wider ranges. Recommend day-by-day iteration for large exports (reference existing multi-day export pattern in transactions.md).

3. **Request Spacing for Bulk Operations** — Show pattern with `time.sleep()` between iterations to avoid 429 storms. Explain why: even though the client handles 429 retries, each retry adds latency. Proactive spacing is faster overall than reactive retry. Include example with configurable delay.

4. **Batch Jobs vs Paginated Lists** — When to use `load_job()` (need full detail + v2 fields on every record, willing to wait) vs paginated `list()` (need summaries quickly, real-time queries). Note that `load_job()` results are cached server-side for 20 minutes — repeated calls within that window return cached data without additional API load.

Keep the same style: code examples, admonitions, realistic data. Cross-reference transactions.md and error-handling.md where appropriate.
  </action>
  <verify>Confirm advanced-patterns.md now has 3 major sections (Multi-Site Operations, Rate Limiting Deep Dive, Performance Optimization). Run `python -m mkdocs build --strict 2>&1 | head -20` to check for markdown issues (if mkdocs available).</verify>
  <done>Performance Optimization section added with 4 subsections, code examples, and cross-references. Guide has 3 complete sections.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `docs/guides/advanced-patterns.md` exists with 3 major sections
- [ ] Multi-Site Operations has 5 subsections with code examples
- [ ] Rate Limiting Deep Dive has 4 subsections with budget forecasting table
- [ ] Performance Optimization has 4 subsections
- [ ] All code examples use realistic Sonny's data (not placeholder)
- [ ] Cross-references to error-handling.md and transactions.md are correct relative links
- [ ] Admonitions used consistently (tip, warning, note)
- [ ] No content duplicated from existing guides
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- advanced-patterns.md is comprehensive and self-contained (with cross-references)
- Guide follows established documentation patterns from prior phases
</success_criteria>

<output>
After completion, create `.planning/phases/17-advanced-patterns/17-01-SUMMARY.md`
</output>
